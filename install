#!/bin/bash -e

INSTALL='sudo pacman -S --needed --noconfirm'

DIR=$(readlink -f $(pwd)/$(dirname $0))

# Pacman repositories
PACMAN_CONF=/etc/pacman.conf
PACMAN_UPDATE=
for REPO in $DIR/pacman/*.conf; do
	if ! grep -q $(basename $REPO .conf) $PACMAN_CONF
	then
		sudo sh -c "(echo; cat $REPO) >> $PACMAN_CONF"
		PACMAN_UPDATE=1
	fi
done
if [ "$PACMAN_UPDATE" != "" ]
then
	sudo pacman -Sy
fi

# Install Aura from AUR manually
if ! which aura >/dev/null 2>&1
then
	$INSTALL wget base-devel abs
	TMPDIR=$(mktemp -d)
	trap "rm -rf $TMPDIR" EXIT
	curl -s https://aur.archlinux.org/packages/au/aura-bin/aura-bin.tar.gz | \
		tar xz -C $TMPDIR
	pushd $TMPDIR/aura-bin >/dev/null
	makepkg
	sudo pacman -U --noconfirm aura-*.pkg.tar.xz
	popd >/dev/null
fi

INSTALL='sudo aura -S --needed --noconfirm'
AUR_INSTALL='sudo aura -A --needed --noconfirm'

# Packages
# Files in packages/ may contain Bash brace expansions
$INSTALL $(bash -c "echo $(echo $(cat packages/* | grep -v '^aur:'))")
$AUR_INSTALL $(bash -c "echo $(echo $(cat packages/* | sed '/^aur:/!d;s/^aur://g'))")

# Desktop session support
sudo mkdir -p /usr/share/xsessions
sudo install $DIR/Xsession/xinit.desktop /usr/share/xsessions
sudo install $DIR/Xsession/Xsession /etc/X11

# Dotfiles
mkdir -p $HOME/.config
ls config | xargs -I FILE ln -sfn $DIR/config/FILE $HOME/.config/FILE
ls dotfiles | xargs -I FILE ln -sfn $DIR/dotfiles/FILE $HOME/.FILE

# Haskell general
$INSTALL cabal-install
[ -d $HOME/.cabal ] || cabal update

# XMonad
$INSTALL libx11 libxrandr libxft
cabal install xmonad MissingH blaze-html

# Tianbar
$INSTALL gtk2 libxml2 webkitgtk2 gtk2hs-buildtools

cabal install tianbar

$HOME/.cabal/bin/xmonad --recompile

# Tianbar config
cd $DIR/config/tianbar
npm install
./node_modules/.bin/bower install
cd - >/dev/null
