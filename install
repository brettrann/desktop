#!/bin/bash -e

INSTALL='sudo pacman -S --needed --noconfirm'

DIR=$(readlink -f $(pwd)/$(dirname $0))

# Pacman configuration
PACMAN_CONF=/etc/pacman.conf
if ! diff -q $PACMAN_CONF $DIR/etc/pacman.conf >/dev/null
then
	sudo install $DIR/etc/pacman.conf $PACMAN_CONF

	sudo pacman-key --init
	sudo pacman-key --populate archlinux

	# Infinality key
	sudo pacman-key -r 962DDE58
	sudo pacman-key --lsign 962DDE58

	sudo pacman -Sy
fi

# Install Aura from AUR manually
if ! which aura >/dev/null 2>&1
then
	$INSTALL wget base-devel abs
	TMPDIR=$(mktemp -d)
	trap "rm -rf $TMPDIR" EXIT
	curl -s https://aur4.archlinux.org/cgit/aur.git/snapshot/aura-bin.tar.gz | \
		tar xz -C $TMPDIR
	pushd $TMPDIR/aura-bin >/dev/null
	makepkg
	sudo pacman -U --noconfirm aura-*.pkg.tar.xz
	popd >/dev/null
fi

INSTALL='sudo aura -S --needed --noconfirm'
AUR_INSTALL='sudo aura -A --needed --noconfirm'

# Packages
# Files in packages/ may contain Bash brace expansions
$INSTALL $(bash -c "echo $(echo $(cat packages/* | grep -v '^aur:'))")
$AUR_INSTALL $(bash -c "echo $(echo $(cat packages/* | sed '/^aur:/!d;s/^aur://g'))")

# Shell
if [ $(getent passwd $USER | cut -d: -f7) != "/bin/zsh" ]
then
	chsh -s /bin/zsh
fi

# Desktop session support
sudo mkdir -p /usr/share/xsessions
sudo install $DIR/Xsession/xinit.desktop /usr/share/xsessions
sudo install $DIR/Xsession/Xsession /etc/X11

./makelinks

# Haskell general
$INSTALL cabal-install
[ -d $HOME/.cabal/packages ] || cabal update

cabal sandbox init

function sandbox_link {
	EXECUTABLE=$1
	SCRIPT=$HOME/bin/$EXECUTABLE
	TARGET=$DIR/.cabal-sandbox/bin/$EXECUTABLE
	: > $SCRIPT
	cat <<EOF >> $SCRIPT
#!/bin/sh
export GHC_PACKAGE_PATH=\$(cd $DIR; cabal exec -- sh -c 'echo \$GHC_PACKAGE_PATH')
exec $TARGET "\$@"
EOF
	chmod +x $SCRIPT
}

# XMonad
$INSTALL libx11 libxrandr libxft
cabal install xmonad MissingH blaze-html

sandbox_link xmonad

# Tianbar
$INSTALL gtk2 libxml2 webkitgtk2 gtk2hs-buildtools

cabal install tianbar

sandbox_link tianbar

$HOME/bin/xmonad --recompile

# Tianbar config
cd $DIR/config/tianbar
npm install
./node_modules/.bin/bower install
cd - >/dev/null

# Hoe
cabal install hoe

sandbox_link hoe

# Hdevtools
cabal install hdevtools

sandbox_link hdevtools
