#!/bin/bash -e

INSTALL='sudo pacman -S --needed --noconfirm'

DIR=$(readlink -f $(pwd)/$(dirname $0))

# Pacman repositories
PACMAN_CONF=/etc/pacman.conf
PACMAN_UPDATE=
if ! grep -q archlinuxfr $PACMAN_CONF
then
	sudo sh -c "cat $DIR/pacman/yaourt.conf >> $PACMAN_CONF"
	PACMAN_UPDATE=1
fi
if ! grep -q infinality-bundle $PACMAN_CONF
then
	sudo sh -c "cat $DIR/pacman/infinality.conf >> $PACMAN_CONF"
	PACMAN_UPDATE=1
fi
if [ "$PACMAN_UPDATE" != "" ]
then
	sudo pacman -Sy
fi

$INSTALL yaourt
INSTALL='sudo yaourt -S --needed --noconfirm'

# System
$INSTALL base-devel dnsutils curl ecryptfs-utils ghc htop iftop iotop lsof \
	ltrace networkmanager net-tools ngrep nmap ntp openssh pkgfile \
	pm-utils rsync screen strace sudo wget whois xorg-server yaourt

# Desktop environment
$INSTALL autojump bash-completion gksu gnome-keyring ibus{,-{pinyin,m17n}} \
	infinality-bundle infinality-bundle-multilib \
	lightdm lightdm-gtk3-greeter lxappearance mosh network-manager-applet \
	notify-osd python-xdg python2-xdg synapse terminator tracker \
	ttf-arphic-ukai ttf-arphic-uming xcompmgr xorg-xinit xscreensaver \
	wqy-microhei wqy-zenhei zeitgeist

sudo install $DIR/Xsession/xinit.desktop /usr/share/xsessions
sudo install $DIR/Xsession/Xsession /etc/X11

# Development
$INSTALL cabal-install git gitg gvim happy ipython{,2} meld moreutils \
	nodejs python{,2}{,-pylint,-virtualenv} qemu sshfs tcpdump tig \
	virt-manager wireshark-gtk

# Applications
$INSTALL aspell{,-{en,ru}} chromium firefox flashplugin file-roller \
	gimp libreoffice-{calc,draw,impress,writer} mencoder pidgin skype \
	thunderbird thunderbird-i18n-{en-gb,en-us,ru,zh-cn} totem


# Dotfiles
ls config | xargs -I FILE ln -sfn $DIR/config/FILE $HOME/.config/FILE
ls dotfiles | xargs -I FILE ln -sfn $DIR/dotfiles/FILE $HOME/.FILE

# Haskell general
$INSTALL cabal-install
[ -d $HOME/.cabal ] || cabal update

# XMonad
$INSTALL libx11 libxrandr libxft
cabal install xmonad xmonad-extras MissingH blaze-html

# Tianbar
$INSTALL gtk2 libxml2 webkitgtk2

cabal install tianbar

$HOME/.cabal/bin/xmonad --recompile

# Tianbar config
cd $DIR/config/tianbar
npm install
./node_modules/.bin/bower install
cd - >/dev/null
